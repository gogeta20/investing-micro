services:
  rust_consumer:
    build:
      context: .
      dockerfile: devops/dockerfiles/broker/Consumer.Dockerfile
    container_name: rust_consumer
    environment:
      AMQP_ADDR: ${AMQP_ADDR}
      OPENSSL_DIR: "/usr"
      MONGO_DB_URL: ${MONGO_DB_URL}
      MONGO_DB_NAME_INTENTS: ${MONGO_DB_NAME_INTENTS}
    volumes:
      - ./project/consumer:/app/src
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - app_network
    ports:
      - "9080:9080"
    # restart: always
    profiles:
      - local

  jenkins:
    build:
      context: .
      dockerfile: devops/dockerfiles/ci/Jenkins.Dockerfile
    container_name: jenkins_micro
    user: root
    ports:
      - "8081:8080"
      - "50000:50000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./devops/volumes/jenkins:/var/jenkins_home:z
    environment:
      - "DOCKER_HOST=unix:///var/run/docker.sock"
    networks:
      - app_network
    profiles:
      - extra

  front_micro:
    build:
      context: .
      dockerfile: devops/dockerfiles/frontend/Vue.Dockerfile
    container_name: front_micro
    ports:
      - "5173:5173"
    entrypoint: [ "/app/entrypoint.sh" ]
    volumes:
      - ./project/front:/app
    environment:
      - MICRO_ENV=${MICRO_ENV}
    networks:
      - app_network
    profiles:
      - local

  symfony_backend:
    build:
      context: .
      dockerfile: devops/dockerfiles/backend/Symfony.Dockerfile
    container_name: symfony_backend
    ports:
      - "9000:9000"
    volumes:
      - ./project/backend/symfony:/var/www/html
      - ./conf/symfony/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini:delegated
    command: >
      sh -c "composer install && php-fpm"
    networks:
      - app_network
    extra_hosts:
      - host.docker.internal:host-gateway
    profiles:
      - local

  django_backend:
    build:
      context: .
      dockerfile: devops/dockerfiles/backend/Django.Dockerfile
    container_name: django_backend
    depends_on:
      - mysql_db
    environment:
      - DB_HOST=mysql_db
      - DB_PORT=3306
      - DB_NAME=investing_micro_db
      - DB_USER=user
      - DB_PASSWORD=password
    ports:
        - "8000:8000"
        - "5678:5678"  # Puerto para debugpy
    volumes:
        - ./project/backend/django:/app:z
        - ./conf/django/data:/app/data:z
    # Comando con debugpy para desarrollo
    command: python -m debugpy --listen 0.0.0.0:5678 manage.py runserver 0.0.0.0:8000
    # command: python manage.py runserver 0.0.0.0:8000
    networks:
        - app_network
    extra_hosts:
        - host.docker.internal:host-gateway
    profiles:
        - local
    # Para mantener el contenedor vivo y poder entrar con zsh
    stdin_open: true
    tty: true

  springboot_backend:
    build:
      context: .
      dockerfile: devops/dockerfiles/backend/SpringBoot.Dockerfile
    container_name: springboot_backend
    ports:
      - "8080:8080"
    volumes:
      - ./project/backend/springboot:/app/code
    #      - ./project/backend/springboot:/app
    networks:
      - app_network
    profiles:
      - extra

  fastapi_backend:
    build:
      context: .
      dockerfile: devops/dockerfiles/backend/FastAPI.Dockerfile
      args:
        MICRO_ENV: ${MICRO_ENV}
    container_name: fastapi_backend
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    ports:
      - "8100:8000"
    volumes:
      - ./project/backend/fastapi:/app
    profiles:
      - local
    networks:
      - app_network

  rabbitmq:
    build:
      context: .
      dockerfile: devops/dockerfiles/broker/RabbitMQ.Dockerfile
    container_name: rabbitmq
    ports:
      - "15672:15672" # Puerto para el panel de administraci√≥n
      - "5672:5672" # Puerto para las conexiones de los clientes
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: your_password
    healthcheck:
      test: [ "CMD", "rabbitmqctl", "status" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network
    profiles:
      - local

  mysql_db:
    build:
      context: .
      dockerfile: devops/dockerfiles/db/MySQL.Dockerfile
    container_name: mysql_db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE-investing_micro_db}
      MYSQL_USER: ${MYSQL_USER-user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD-password}
    ports:
      - "3306:3306"
    volumes:
      - ./devops/volumes/mysql:/var/lib/mysql:z
      - ./conf/mysql/db/files:/var/www/html
    networks:
      - app_network
    profiles:
       - local
       - extra

  mongo_db:
    build:
      context: .
      dockerfile: devops/dockerfiles/db/Mongo.Dockerfile
    container_name: mongo_db
    ports:
      - "27017:27017"
    volumes:
      - ./devops/volumes/mongo:/data/db:z
      - ./conf/mongodb/db/files:/var/www/html
    networks:
      - app_network
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
    profiles:
      - local

  postgres_db:
    build:
      context: .
      dockerfile: devops/dockerfiles/db/PostgreSQL.Dockerfile
    container_name: postgres_db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: my_database
    ports:
      - "5432:5432"
    volumes:
      - ./devops/volumes/postgres:/var/lib/postgresql/data:z
    networks:
      - app_network
    profiles:
      - extra

  nginx_proxy:
    build:
      context: .
      dockerfile: devops/dockerfiles/proxy/Nginx.Dockerfile
      args:
        MICRO_ENV: ${MICRO_ENV}
    container_name: nginx_proxy
    #    volumes:
    #      - ./conf/nginx/nginx.conf:/etc/nginx/nginx.conf
    volumes:
      - ./conf/nginx:/src
    ports:
      - "80:80"
    depends_on:
      - symfony_backend
      - django_backend
      # - springboot_backend
      # - front_micro
    networks:
      - app_network
    profiles:
      - local

  mailhog:
    image: mailhog/mailhog
    container_name: mailhog_micro
    ports:
      - "8025:8025" # Interfaz web
      - "1025:1025" # Puerto SMTP
    networks:
      - app_network
    profiles:
      - extra

  nocodb:
    image: nocodb/nocodb:latest
    container_name: nocodb_micro
    ports:
      - "8082:8080"
    environment:
      - NC_DB_TYPE=mysql # Cambiado a mysql
      - NC_DB_HOST=mysql_db # Nombre del contenedor de MySQL
      - NC_DB_PORT=3306 # Puerto de MySQL
      - NC_DB_USER=user
      - NC_DB_PASSWORD=password
      - NC_DB_NAME=my_database
      - NC_AUTH_JWT_SECRET=gbcv123M
    depends_on:
      - mysql_db
    # restart: always
    volumes:
      - ./devops/volumes/nocodb:/usr/app/data:z
    networks:
      - app_network
    profiles:
      - extra

  drawdb:
    image: ghcr.io/drawdb-io/drawdb:latest
    container_name: drawdb
    environment:
        DB_TYPE: mysql
        DB_HOST: mysql_db
        DB_PORT: 3306
        DB_USER: user
        DB_PASSWORD: password
        DB_NAME: investing_micro_db
    ports:
        - "8084:80"
    depends_on:
        - mysql_db
    networks:
        - app_network
    profiles:
        - extra

  chartdb:
    image: ghcr.io/chartdb/server:latest
    container_name: chartdb
    # volumes:
    # - ./conf/chartdb/config.json:/app/config/config.json:z
    environment:
      - DB_TYPE=mysql
      - DB_HOST=mysql_db
      - DB_PORT=3306
      - DB_USER=user
      - DB_PASSWORD=password
      - DB_NAME=investing_micro_db
    ports:
      - "8083:3000"
    depends_on:
      - mysql_db
    networks:
      - app_network
    profiles:
      - disabled
      
  gitlab:
    image: gitlab/gitlab-ce:16.11.1-ce.0
    container_name: gitlab_micro
    hostname: gitlab.local
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://localhost:8090'
        gitlab_rails['initial_root_password'] ='S3cure!X9z$QwT7'
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        # Reducir uso de memoria para desarrollo local
        puma['worker_processes'] = 2
        postgresql['shared_buffers'] = "256MB"
        postgresql['max_worker_processes'] = 4
        prometheus_monitoring['enable'] = false
    ports:
      - "8090:8090"
      - "2222:22"
    volumes:
      - ./devops/volumes/gitlab/config:/etc/gitlab:z
      - ./devops/volumes/gitlab/logs:/var/log/gitlab:z
      - ./devops/volumes/gitlab/data:/var/opt/gitlab:z
    shm_size: '256m'
    networks:
      - app_network
    profiles:
      - ci
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/-/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 240s

  gitlab-runner:
    image: gitlab/gitlab-runner:v16.11.1
    container_name: gitlab_runner
    volumes:
      - ./devops/volumes/gitlab-runner:/etc/gitlab-runner:z
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - app_network
    profiles:
      - ci
    depends_on:
      gitlab:
        condition: service_healthy
    restart: unless-stopped

networks:
  app_network:
    driver: bridge
