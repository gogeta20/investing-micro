version: '3.9'

services:
    rust_consumer:
        build:
            context: .
            dockerfile: devops/dockerfiles/broker/Consumer.Dockerfile
        container_name: rust_consumer
        environment:
          AMQP_ADDR: "amqp://admin:your_password@rabbitmq:5672/%2f"
          OPENSSL_DIR: "/usr"
        volumes:
            - ./project/consumer:/app/src
        depends_on:
            rabbitmq:
                condition: service_healthy
        networks:
            - app_network
        restart: always

    jenkins_micro:
        build:
            context: .
            dockerfile: devops/dockerfiles/ci/Jenkins.Dockerfile
        container_name: jenkins_micro
        user: root
        ports:
            - "8081:8080"
            - "50000:50000"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - ./devops/volumes/jenkins:/var/jenkins_home:z
        environment:
            - "DOCKER_HOST=unix:///var/run/docker.sock"
        networks:
            - app_network

    front_micro:
        build:
            context: .
            dockerfile: devops/dockerfiles/frontend/Vue.Dockerfile
        container_name: front_micro
        ports:
            - "5173:5173"
        entrypoint: [ "/app/entrypoint.sh" ]
        volumes:
            - ./project/front:/app
        networks:
            - app_network

    symfony_backend:
        build:
            context: .
            dockerfile: devops/dockerfiles/backend/Symfony.Dockerfile
        container_name: symfony_backend
        ports:
            - "9000:9000"
        volumes:
            - ./project/backend/symfony:/var/www/html
            - ./conf/symfony/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini:delegated
        command: >
            sh -c "composer install && php-fpm"
        networks:
            - app_network
        extra_hosts:
            - "host.docker.internal:host-gateway"

    django_backend:
        build:
            context: .
            dockerfile: devops/dockerfiles/backend/Django.Dockerfile
        container_name: django_backend
        ports:
            - "8000:8000"
        volumes:
            - ./project/backend/django:/app:z
            - ./conf/django/data:/app/data:z
            - /var/run/docker.sock:/var/run/docker.sock
        networks:
            - app_network

    springboot_backend:
        build:
            context: .
            dockerfile: devops/dockerfiles/backend/SpringBoot.Dockerfile
        container_name: springboot_backend
        ports:
            - "8080:8080"
        volumes:
            - ./project/backend/springboot:/app/code
        #      - ./project/backend/springboot:/app
        networks:
            - app_network

    rabbitmq:
        build:
            context: .
            dockerfile: devops/dockerfiles/broker/RabbitMQ.Dockerfile
        container_name: rabbitmq
        ports:
            - "15672:15672"  # Puerto para el panel de administraci√≥n
            - "5672:5672"     # Puerto para las conexiones de los clientes
        environment:
            RABBITMQ_DEFAULT_USER: admin
            RABBITMQ_DEFAULT_PASS: your_password
        healthcheck:
            test: ["CMD", "rabbitmqctl", "status"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - app_network

    mysql_db:
        build:
            context: .
            dockerfile: devops/dockerfiles/db/MySQL.Dockerfile
        container_name: mysql_db
        environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            MYSQL_DATABASE: ${MYSQL_DATABASE}
            MYSQL_USER: ${MYSQL_USER}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD}
        ports:
            - "3306:3306"
        volumes:
            - ./devops/volumes/mysql:/var/lib/mysql:z
            - ./conf/mysql/db/files:/var/www/html
        networks:
            - app_network

    mongo_db:
        build:
            context: .
            dockerfile: devops/dockerfiles/db/Mongo.Dockerfile
        container_name: mongo_db
        ports:
            - "27017:27017"
        volumes:
            - ./devops/volumes/mongo:/data/db:z
            - ./conf/mongodb/db/files:/var/www/html
        networks:
            - app_network
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: password

    postgres_db:
        build:
            context: .
            dockerfile: devops/dockerfiles/db/PostgreSQL.Dockerfile
        container_name: postgres_db
        environment:
            POSTGRES_USER: user
            POSTGRES_PASSWORD: password
            POSTGRES_DB: my_database
        ports:
            - "5432:5432"
        volumes:
            - ./devops/volumes/postgres:/var/lib/postgresql/data:z
        networks:
            - app_network

    nginx_proxy:
        build:
            context: .
            dockerfile: devops/dockerfiles/proxy/Nginx.Dockerfile
        container_name: nginx_proxy
        #    volumes:
        #      - ./conf/nginx/nginx.conf:/etc/nginx/nginx.conf
        volumes:
            - ./conf/nginx:/src
        ports:
            - "80:80"
        depends_on:
            - symfony_backend
            - django_backend
            - springboot_backend
            - front_micro
        networks:
            - app_network

    mailhog:
        image: mailhog/mailhog
        container_name: mailhog_micro
        ports:
            - "8025:8025"  # Interfaz web
            - "1025:1025"  # Puerto SMTP
        networks:
            - app_network

    nocodb:
        image: nocodb/nocodb:latest
        container_name: nocodb_micro
        ports:
            - "8082:8080"
        environment:
            - NC_DB_TYPE=mysql  # Cambiado a mysql
            - NC_DB_HOST=mysql_db_micro  # Nombre del contenedor de MySQL
            - NC_DB_PORT=3306  # Puerto de MySQL
            - NC_DB_USER=user
            - NC_DB_PASSWORD=password
            - NC_DB_NAME=my_database
            - NC_AUTH_JWT_SECRET=gbcv123M
        depends_on:
            - mysql_db
        restart: always
        volumes:
            - ./devops/volumes/nocodb:/usr/app/data:z
        networks:
            - app_network

    chartdb:
        image: ghcr.io/chartdb/chartdb:latest
        container_name: chartdb
        environment:
            - DB_TYPE=mysql
            - DB_HOST=mysql_db
            - DB_PORT=3306
            - DB_USER=user
            - DB_PASSWORD=password
            - DB_NAME=my_database
        ports:
            - "8083:80"
        depends_on:
            - mysql_db
        networks:
            - app_network

networks:
    app_network:
        driver: bridge
